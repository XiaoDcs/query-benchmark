<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Page Scorer - Electron</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 15px;
      background-color: #f5f5f5;
      overflow-x: hidden;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
      margin: 0 0 15px 0;
      font-size: 24px;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .nav-buttons {
      display: flex;
      gap: 8px;
    }
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    button {
      padding: 8px 12px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #3367d6;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .content {
      display: flex;
      gap: 15px;
      height: calc(100vh - 120px); /* å‡å°‘é¡¶éƒ¨é¢„ç•™ç©ºé—´ï¼Œä»160pxæ”¹ä¸º120px */
      min-height: 650px; /* å¢åŠ æœ€å°é«˜åº¦ï¼Œä»600pxæ”¹ä¸º650px */
    }
    .web-view {
      flex: 1;
      min-width: 500px;
      display: flex;
      flex-direction: column;
    }
    .web-frame {
      width: 100%;
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 4px;
      height: 100%; /* å¼ºåˆ¶å æ®å…¨éƒ¨é«˜åº¦ */
      min-height: 400px; /* è®¾ç½®æœ€å°é«˜åº¦ç¡®ä¿åŸºæœ¬å¯ç”¨ */
      display: flex; /* è®©å†…éƒ¨å†…å®¹ä¹Ÿä½¿ç”¨flexå¸ƒå±€ */
      align-items: center;
      justify-content: center;
    }
    .sidebar {
      width: 320px;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 100%;
      overflow-y: auto;
    }
    .info-panel, .score-panel {
      background-color: #f9f9f9;
      padding: 12px;
      border-radius: 4px;
      flex-shrink: 0;
    }
    .info-panel h3, .score-panel h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }
    .info-panel p {
      margin: 8px 0;
      font-size: 13px;
    }
    .score-options {
      display: flex;
      gap: 8px;
      margin: 10px 0;
    }
    .score-button {
      flex: 1;
      text-align: center;
      padding: 10px 6px;
      font-size: 13px;
    }
    .pass {
      background-color: #34a853;
    }
    .pass:hover {
      background-color: #2e8b47;
    }
    .fail {
      background-color: #ea4335;
    }
    .fail:hover {
      background-color: #d33426;
    }
    .status {
      margin-top: 10px;
      padding: 8px;
      background-color: #f2f2f2;
      border-radius: 4px;
      text-align: center;
      font-size: 12px;
      flex-shrink: 0;
    }
    .screenshot-preview {
      max-width: 100%;
      max-height: 120px;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      font-size: 16px;
      color: #666;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      border-radius: 4px;
    }
    .hidden {
      display: none;
    }
    .url-display {
      word-break: break-all;
      color: #1a73e8;
      text-decoration: none;
      font-size: 12px;
    }
    .url-display:hover {
      text-decoration: underline;
    }
    .progress-bar {
      width: 100%;
      height: 4px;
      background-color: #e0e0e0;
      border-radius: 2px;
      margin: 8px 0;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background-color: #4285f4;
      transition: width 0.3s ease;
    }
    .web-container {
      position: relative;
      flex: 1;
    }
    
    /* ç´§å‡‘çš„ç¼©ç•¥å›¾å®¹å™¨ */
    #thumbnail-container {
      margin: 10px 0;
    }
    #thumbnail-container strong {
      font-size: 13px;
    }
    #thumbnail-preview, #thumbnail-placeholder {
      max-height: 80px;
      max-width: 100%;
      margin-top: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      display: block;
    }
    #thumbnail-placeholder {
      padding: 20px;
      background-color: #f5f5f5;
      text-align: center;
      color: #666;
      font-size: 12px;
    }
    
    /* ç§»åŠ¨ç«¯å“åº”å¼ */
    @media (max-width: 900px) {
      .content {
        flex-direction: column;
        height: auto;
        min-height: auto;
      }
      .sidebar {
        width: 100%;
        min-width: auto;
        max-height: none;
      }
      .web-view {
        min-width: auto;
        height: 50vh;
        min-height: 400px;
      }
      .controls {
        flex-direction: column;
        gap: 8px;
      }
      .nav-buttons, .action-buttons {
        justify-content: center;
        flex-wrap: wrap;
      }
    }
    
    /* è‡ªåŠ¨è·³è½¬å¼€å…³æ ·å¼ */
    .settings-panel {
      background-color: #f0f8ff;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid #b3d9ff;
      flex-shrink: 0;
    }
    .settings-panel h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #1976d2;
    }
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0;
    }
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background-color: #ccc;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .toggle-switch.active {
      background-color: #4285f4;
    }
    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background-color: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    .toggle-switch.active .toggle-slider {
      transform: translateX(26px);
    }
    .toggle-label {
      font-size: 13px;
      color: #333;
    }
    .preload-status {
      font-size: 11px;
      color: #666;
      margin-top: 8px;
      padding: 6px;
      background-color: #f8f9fa;
      border-radius: 3px;
    }
    .shortcuts-info {
      font-size: 11px;
      color: #666;
      margin-top: 8px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸŒ Web Page Scorer</h1>
    
    <div class="controls">
      <div class="nav-buttons">
        <button id="file-btn">ğŸ“ Select Excel File</button>
        <button id="prev-btn" disabled>â† Previous</button>
        <button id="next-btn" disabled>Next â†’</button>
        <button id="reload-btn" disabled>ğŸ”„ Reload</button>
      </div>
      <div class="action-buttons">
        <button id="save-btn" disabled>ğŸ’¾ Save</button>
        <button id="open-external-btn" disabled>ğŸ”— Open in Browser</button>
      </div>
    </div>
    
    <div class="content">
      <div class="web-view">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
        <div class="web-container">
          <div id="web-frame" class="web-frame">
            <div style="text-align: center; color: #666; padding: 20px;">
              <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“„</div>
              <div style="font-size: 18px; margin-bottom: 10px;">Please select an Excel file to start</div>
              <div style="font-size: 14px; color: #999;">Click "Select Excel File" button above</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="sidebar">
        <div class="info-panel">
          <h3>ğŸ“‹ Page Information</h3>
          <p><strong>Progress:</strong> <span id="page-counter">-</span></p>
          <p><strong>Query:</strong> <span id="current-query">-</span></p>
          <p><strong>URL:</strong> <a href="#" id="current-url" class="url-display" target="_blank">-</a></p>
          <p><strong>Current Score:</strong> <span id="current-score">Not scored</span></p>
          
          <div id="thumbnail-container">
            <strong>Thumbnail:</strong>
            <img id="thumbnail-preview" class="hidden" alt="Thumbnail" />
            <div id="thumbnail-placeholder">No thumbnail available</div>
          </div>
        </div>
        
        <div class="settings-panel">
          <h3>âš™ï¸ Settings</h3>
          
          <!-- Auto-advance setting -->
          <div class="toggle-container">
            <div class="toggle-switch" id="auto-next-toggle">
              <div class="toggle-slider"></div>
            </div>
            <label class="toggle-label">Auto-advance on Pass</label>
          </div>
          
          <!-- Preload count setting -->
          <div style="margin: 10px 0;">
            <label for="preload-count" style="display: block; margin-bottom: 5px; font-size: 13px; color: #333;">Preload pages:</label>
            <select id="preload-count" style="width: 100%; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
              <option value="0">Disabled</option>
              <option value="3">3 pages</option>
              <option value="5" selected>5 pages</option>
              <option value="10">10 pages</option>
              <option value="15">15 pages</option>
            </select>
          </div>
          
          <!-- Page jump -->
          <div style="margin: 10px 0;">
            <label for="page-jump" style="display: block; margin-bottom: 5px; font-size: 13px; color: #333;">Jump to page:</label>
            <div style="display: flex; gap: 5px;">
              <input type="number" id="page-jump" min="1" max="1" value="1" style="flex: 1; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" placeholder="Page #">
              <button id="jump-btn" style="padding: 4px 12px; font-size: 12px;">Go</button>
            </div>
          </div>
          
          <div class="preload-status" id="preload-status">
            Preloading: Ready
          </div>
          
          <div class="shortcuts-info">
            <strong>Shortcuts:</strong><br>
            â†‘ Pass (saves as 1)<br>
            â†“ Fail (saves as 0)<br>
            Ctrl+S Save manually
          </div>
        </div>
        
        <div class="score-panel">
          <h3>Score this page</h3>
          <div class="score-options">
            <button id="pass-btn" class="score-button pass">âœ… Pass (â†‘)</button>
            <button id="fail-btn" class="score-button fail">âŒ Fail (â†“)</button>
          </div>
          <button id="screenshot-btn" style="width: 100%; margin-top: 8px;">ğŸ“¸ Take Screenshot</button>
          
          <div style="margin-top: 15px;">
            <label for="issue-input" style="display: block; margin-bottom: 5px; font-weight: bold;">Issue Notes:</label>
            <textarea id="issue-input" rows="3" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 8px; resize: vertical;" placeholder="Enter any issues or notes..."></textarea>
          </div>
          
          <div style="margin-top: 10px;">
            <img id="screenshot-preview" class="screenshot-preview hidden" alt="Screenshot" />
            <div id="no-screenshot" style="text-align: center; padding: 20px; background-color: #f5f5f5; border: 1px dashed #ccc; border-radius: 4px; color: #666; font-size: 12px;">
              ğŸ“· No screenshot taken
            </div>
          </div>
        </div>
        
        <div class="status" id="status">Ready to start</div>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer, shell } = require('electron');
    
    // DOM elements
    const fileBtn = document.getElementById('file-btn');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const passBtn = document.getElementById('pass-btn');
    const failBtn = document.getElementById('fail-btn');
    const screenshotBtn = document.getElementById('screenshot-btn');
    const saveBtn = document.getElementById('save-btn');
    const reloadBtn = document.getElementById('reload-btn');
    const openExternalBtn = document.getElementById('open-external-btn');
    const webFrame = document.getElementById('web-frame');
    const pageCounterEl = document.getElementById('page-counter');
    const currentQueryEl = document.getElementById('current-query');
    const currentUrlEl = document.getElementById('current-url');
    const currentScoreEl = document.getElementById('current-score');
    const issueInput = document.getElementById('issue-input');
    const screenshotPreview = document.getElementById('screenshot-preview');
    const noScreenshotDiv = document.getElementById('no-screenshot');
    const statusEl = document.getElementById('status');
    const progressFill = document.getElementById('progress-fill');
    const thumbnailPreview = document.getElementById('thumbnail-preview');
    const thumbnailPlaceholder = document.getElementById('thumbnail-placeholder');
    const autoNextToggle = document.getElementById('auto-next-toggle');
    const preloadStatusEl = document.getElementById('preload-status');
    const preloadCountSelect = document.getElementById('preload-count');
    const pageJumpInput = document.getElementById('page-jump');
    const jumpBtn = document.getElementById('jump-btn');
    
    // App state
    let excelData = [];
    let currentIndex = 1; // ä»1å¼€å§‹ï¼Œè·³è¿‡æ ‡é¢˜è¡Œ
    let columns = {};
    let autoNextEnabled = true; // é»˜è®¤å¼€å¯è‡ªåŠ¨è·³è½¬
    let preloadQueue = new Set(); // é¢„åŠ è½½é˜Ÿåˆ—
    let preloadedPages = new Map(); // é¢„åŠ è½½ç¼“å­˜
    let maxPreloadPages = 5; // é»˜è®¤é¢„åŠ è½½5é¡µ
    
    // è‡ªåŠ¨è·³è½¬å¼€å…³äº‹ä»¶
    autoNextToggle.addEventListener('click', () => {
      autoNextEnabled = !autoNextEnabled;
      autoNextToggle.classList.toggle('active', autoNextEnabled);
      updateStatus(autoNextEnabled ? 'Auto-advance enabled' : 'Auto-advance disabled');
    });
    
    // é¢„åŠ è½½é¡µæ•°è®¾ç½®äº‹ä»¶
    preloadCountSelect.addEventListener('change', (e) => {
      maxPreloadPages = parseInt(e.target.value);
      updateStatus(`Preload count set to ${maxPreloadPages} pages`);
      
      // é‡æ–°å¼€å§‹é¢„åŠ è½½
      if (excelData && excelData.length > 1) {
        startPreloading();
      }
    });
    
    // é¡µç è·³è½¬äº‹ä»¶
    jumpBtn.addEventListener('click', () => {
      const targetPage = parseInt(pageJumpInput.value);
      const maxPage = excelData ? excelData.length - 1 : 1;
      
      if (targetPage >= 1 && targetPage <= maxPage) {
        loadPage(targetPage);
        updateStatus(`Jumped to page ${targetPage}`);
      } else {
        showError(`Invalid page number. Please enter a number between 1 and ${maxPage}`);
        pageJumpInput.value = currentIndex;
      }
    });
    
    // é¡µç è¾“å…¥æ¡†å›è½¦äº‹ä»¶
    pageJumpInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        jumpBtn.click();
      }
    });
    
    // åˆå§‹åŒ–å¼€å…³çŠ¶æ€
    autoNextToggle.classList.add('active');
    
    // File selection
    fileBtn.addEventListener('click', async () => {
      try {
        const result = await ipcRenderer.invoke('select-file');
        if (result.success) {
          await loadExcelData();
        }
      } catch (error) {
        showError(`File selection failed: ${error.message}`);
      }
    });
    
    // Load Excel data
    async function loadExcelData() {
      try {
        updateStatus('Loading Excel file...');
        const result = await ipcRenderer.invoke('load-excel');
        
        if (result.success) {
          excelData = result.data;
          columns = result.columns;
          currentIndex = 1; // ä»1å¼€å§‹ï¼Œè·³è¿‡æ ‡é¢˜è¡Œ
          
          // æ›´æ–°é¡µç è·³è½¬è¾“å…¥æ¡†çš„æœ€å¤§å€¼
          const maxPage = excelData.length - 1;
          pageJumpInput.max = maxPage;
          pageJumpInput.value = 1;
          
          // Enable controls
          prevBtn.disabled = false;
          nextBtn.disabled = false;
          saveBtn.disabled = false;
          reloadBtn.disabled = false;
          openExternalBtn.disabled = false;
          
          updateStatus(`âœ… Loaded ${maxPage} pages from Excel file`);
          loadPage(1); // åŠ è½½ç¬¬ä¸€é¡µæ•°æ®
          
          // å¼€å§‹é¢„åŠ è½½
          startPreloading();
        } else {
          showError(result.error || 'Failed to load Excel file');
        }
      } catch (error) {
        showError(`Failed to load Excel: ${error.message}`);
      }
    }
    
    // é¢„åŠ è½½é€»è¾‘
    function startPreloading() {
      // æ¸…ç©ºä¹‹å‰çš„é¢„åŠ è½½
      preloadQueue.clear();
      preloadedPages.clear();
      
      // é¢„åŠ è½½å½“å‰é¡µé¢åçš„é¡µé¢
      preloadNextPages();
    }
    
    function preloadNextPages() {
      if (!excelData || excelData.length <= 1 || maxPreloadPages === 0) {
        updatePreloadStatus('Preloading disabled');
        return;
      }
      
      let preloadCount = 0;
      const dataLength = excelData.length; // åŒ…å«æ ‡é¢˜è¡Œçš„æ€»é•¿åº¦
      const maxDataIndex = dataLength - 1; // æœ€åä¸€è¡Œæ•°æ®çš„ç´¢å¼•
      
      for (let i = currentIndex + 1; i <= Math.min(currentIndex + maxPreloadPages, maxDataIndex); i++) {
        if (!preloadedPages.has(i) && !preloadQueue.has(i)) {
          // æ£€æŸ¥è¿™ä¸€è¡Œæ˜¯å¦æœ‰æœ‰æ•ˆçš„URL
          const rowData = excelData[i];
          const url = rowData && rowData[columns.link];
          if (url && url.trim() && url.startsWith('http')) {
            preloadQueue.add(i);
            preloadCount++;
          }
        }
      }
      
      if (preloadCount > 0) {
        updatePreloadStatus(`Preloading ${preloadCount} pages...`);
        processPreloadQueue();
      } else {
        updatePreloadStatus(`${preloadedPages.size} pages preloaded`);
      }
    }
    
    async function processPreloadQueue() {
      if (preloadQueue.size === 0) return;
      
      const pageIndex = preloadQueue.values().next().value;
      preloadQueue.delete(pageIndex);
      
      try {
        const rowData = excelData[pageIndex];
        const url = rowData && rowData[columns.link];
        
        if (url && url.trim() && url.startsWith('http')) {
          // åœ¨åå°é¢„åŠ è½½URL
          const result = await ipcRenderer.invoke('preload-url', url);
          if (result.success) {
            preloadedPages.set(pageIndex, {
              url: url,
              loaded: true,
              timestamp: Date.now()
            });
            console.log(`Successfully preloaded page ${pageIndex}: ${url}`);
          }
        }
      } catch (error) {
        console.log(`Preload failed for page ${pageIndex}:`, error);
      }
      
      // ç»§ç»­å¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ª
      if (preloadQueue.size > 0) {
        setTimeout(() => processPreloadQueue(), 200); // å¢åŠ é—´éš”åˆ°200mså‡å°‘å¡é¡¿
      } else {
        updatePreloadStatus(`${preloadedPages.size} pages preloaded`);
      }
    }
    
    function updatePreloadStatus(message) {
      preloadStatusEl.textContent = message;
    }
    
    // Load specific page
    function loadPage(index) {
      if (!excelData || excelData.length <= 1) return;
      
      // Auto-save previous page when navigating
      if (currentIndex !== index) {
        autoSave();
      }
      
      const maxIndex = excelData.length - 1;
      currentIndex = Math.max(1, Math.min(index, maxIndex)); // ç¡®ä¿ä¸å°äº1ï¼ˆè·³è¿‡æ ‡é¢˜è¡Œï¼‰
      
      // Update page jump input value
      pageJumpInput.value = currentIndex;
      
      // Update navigation buttons
      prevBtn.disabled = currentIndex <= 1; // ç¬¬ä¸€é¡µæ˜¯ç´¢å¼•1
      nextBtn.disabled = currentIndex >= maxIndex;
      
      // Update progress (åŸºäºå®é™…æ•°æ®é¡µæ•°ï¼Œä¸åŒ…æ‹¬æ ‡é¢˜è¡Œ)
      const totalDataPages = maxIndex; // æ€»æ•°æ®é¡µæ•°
      const currentDataPage = currentIndex; // å½“å‰æ•°æ®é¡µ
      const progress = totalDataPages > 0 ? (currentDataPage / totalDataPages) * 100 : 0;
      progressFill.style.width = `${progress}%`;
      
      const rowData = excelData[currentIndex];
      if (!rowData) return;
      
      // Update page counter (æ˜¾ç¤ºç»™ç”¨æˆ·çš„é¡µç ï¼Œä»1å¼€å§‹)
      pageCounterEl.textContent = `${currentIndex}/${maxIndex}`;
      
      // Load query data
      const queryData = rowData[columns.description] || rowData[columns.query] || 'N/A';
      currentQueryEl.textContent = queryData;
      
      // Load URL
      const url = rowData[columns.link];
      if (url) {
        currentUrlEl.textContent = url;
        currentUrlEl.href = url;
      } else {
        currentUrlEl.textContent = 'No URL available';
        currentUrlEl.href = '#';
      }
      
      // Load score data
      const resultData = rowData[columns.result];
      if (resultData === 1) {
        currentScoreEl.textContent = 'âœ… Passed (1)';
        currentScoreEl.style.color = '#388e3c';
      } else if (resultData === 0) {
        currentScoreEl.textContent = 'âŒ Failed (0)';
        currentScoreEl.style.color = '#d32f2f';
      } else {
        currentScoreEl.textContent = 'Not scored';
        currentScoreEl.style.color = '#666';
      }
      
      // Load thumbnail
      const thumbnailUrl = rowData[columns.thumbnail_link];
      if (thumbnailUrl) {
        thumbnailPreview.src = thumbnailUrl;
        thumbnailPreview.classList.remove('hidden');
        thumbnailPlaceholder.style.display = 'none';
        thumbnailPreview.onerror = () => {
          thumbnailPreview.classList.add('hidden');
          thumbnailPlaceholder.style.display = 'block';
        };
      } else {
        thumbnailPreview.classList.add('hidden');
        thumbnailPlaceholder.style.display = 'block';
      }
      
      // Load screenshot data
      const screenshotData = rowData[columns.screenshot];
      if (screenshotData) {
        if (screenshotData.startsWith('screenshots/') || screenshotData.includes('/')) {
          // File path - load from file
          ipcRenderer.invoke('load-screenshot', screenshotData).then(result => {
            if (result.success) {
              const imgSrc = `data:image/png;base64,${result.data}`;
              screenshotPreview.src = imgSrc;
              screenshotPreview.classList.remove('hidden');
              noScreenshotDiv.style.display = 'none';
              screenshotPreview.onclick = () => {
                const newWindow = window.open();
                newWindow.document.write(`<img src="${imgSrc}" style="max-width: 100%; max-height: 100vh; object-fit: contain;">`);
              };
            } else {
              screenshotPreview.classList.add('hidden');
              noScreenshotDiv.style.display = 'flex';
            }
          });
        } else {
          // Legacy base64 without data prefix
          const imgSrc = `data:image/png;base64,${screenshotData}`;
          screenshotPreview.src = imgSrc;
          screenshotPreview.classList.remove('hidden');
          noScreenshotDiv.style.display = 'none';
          screenshotPreview.onclick = () => {
            const newWindow = window.open();
            newWindow.document.write(`<img src="${imgSrc}" style="max-width: 100%; max-height: 100vh; object-fit: contain;">`);
          };
        }
      } else {
        screenshotPreview.classList.add('hidden');
        noScreenshotDiv.style.display = 'flex';
        screenshotPreview.onclick = null;
      }
      
      // Load issue data
      const issueData = rowData[columns.issue] || '';
      issueInput.value = issueData;
      
      // Load URL in webview
      if (url && url.trim() && url.startsWith('http')) {
        // æ£€æŸ¥æ˜¯å¦å·²é¢„åŠ è½½
        if (preloadedPages.has(currentIndex)) {
          updateStatus(`Loading: ${url} (preloaded)`);
          webFrame.innerHTML = '<div style="text-align: center; padding: 20px; color: #4285f4;"><div style="margin-bottom: 10px;">âš¡ Preloaded website loaded instantly</div><div style="font-size: 12px; color: #666;">You can see the actual website content in the embedded browser view</div></div>';
        } else {
          updateStatus(`Loading: ${url}`);
          webFrame.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ğŸ”„ Loading website...</div>';
        }
        
        // Adjust BrowserView position first
        adjustBrowserViewPosition();
        
        // Use IPC to load URL in BrowserView
        ipcRenderer.invoke('load-url', url).then(result => {
          if (result.success) {
            webFrame.innerHTML = '<div style="text-align: center; padding: 20px; color: #4285f4;"><div style="margin-bottom: 10px;">âœ… Website loaded in the view above</div><div style="font-size: 12px; color: #666;">You can see the actual website content in the embedded browser view</div></div>';
            updateStatus('Website loaded successfully');
          } else {
            webFrame.innerHTML = `
              <div style="text-align: center; padding: 20px; color: #d32f2f;">
                <div style="margin-bottom: 15px;">âš ï¸ Website could not be embedded</div>
                <div style="font-size: 12px; color: #666; margin-bottom: 15px;">
                  This is common with some websites due to security restrictions.<br/>
                  You can still use the "Open in Browser" button below to view it.
                </div>
                <div style="font-size: 11px; color: #999;">Error: ${result.error}</div>
              </div>
            `;
            updateStatus(`Failed to load website: ${result.error}`);
          }
        }).catch(error => {
          webFrame.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #d32f2f;">
              <div style="margin-bottom: 15px;">âŒ Loading Error</div>
              <div style="font-size: 12px; color: #666; margin-bottom: 15px;">
                There was an error loading this website.<br/>
                You can still score it and use "Open in Browser" to view it externally.
              </div>
              <div style="font-size: 11px; color: #999;">Error: ${error.message}</div>
            </div>
          `;
          updateStatus(`Error loading website: ${error.message}`);
        });
      } else {
        webFrame.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">ğŸ“ No valid URL available for this entry</div>';
        updateStatus('No valid URL available');
      }
      
      // è§¦å‘ä¸‹ä¸€æ‰¹é¢„åŠ è½½
      preloadNextPages();
    }
    
    // Event listeners
    prevBtn.addEventListener('click', () => loadPage(currentIndex - 1));
    nextBtn.addEventListener('click', () => loadPage(currentIndex + 1));
    
    // ä¿®æ”¹PassæŒ‰é’®è¡Œä¸ºï¼Œæ”¯æŒè‡ªåŠ¨è·³è½¬
    passBtn.addEventListener('click', () => {
      excelData[currentIndex][columns.result] = 1;
      currentScoreEl.textContent = 'âœ… Passed (1)';
      currentScoreEl.style.color = '#388e3c';
      updateStatus('Marked as Passed');
      // Auto-save after scoring
      autoSave();
      
      // è‡ªåŠ¨è·³è½¬åˆ°ä¸‹ä¸€é¡µï¼ˆå¦‚æœå¼€å¯äº†è‡ªåŠ¨è·³è½¬ï¼‰
      if (autoNextEnabled && currentIndex < excelData.length - 1) {
        setTimeout(() => {
          loadPage(currentIndex + 1);
        }, 300); // 300mså»¶è¿Ÿè®©ç”¨æˆ·çœ‹åˆ°åé¦ˆ
      }
    });
    
    failBtn.addEventListener('click', () => {
      excelData[currentIndex][columns.result] = 0;
      currentScoreEl.textContent = 'âŒ Failed (0)';
      currentScoreEl.style.color = '#d32f2f';
      updateStatus('Marked as Failed');
      // Auto-save after scoring
      autoSave();
    });
    
    screenshotBtn.addEventListener('click', async () => {
      try {
        updateStatus('Taking screenshot...');
        const result = await ipcRenderer.invoke('take-screenshot');
        
        if (result.success) {
          // Use base64 for immediate display
          const screenshotData = `data:image/png;base64,${result.screenshot}`;
          screenshotPreview.src = screenshotData;
          screenshotPreview.classList.remove('hidden');
          noScreenshotDiv.style.display = 'none';
          
          // Save file path to Excel (not base64 to avoid character limit)
          excelData[currentIndex][columns.screenshot] = result.filepath;
          
          screenshotPreview.onclick = () => {
            const newWindow = window.open();
            newWindow.document.write(`<img src="${screenshotData}" style="max-width: 100%; max-height: 100vh; object-fit: contain;">`);
          };
          
          updateStatus('Screenshot taken and saved successfully');
          // Auto-save after taking screenshot
          autoSave();
        } else {
          showError('Failed to take screenshot');
        }
      } catch (error) {
        showError(`Screenshot failed: ${error.message}`);
      }
    });
    
    saveBtn.addEventListener('click', async () => {
      try {
        updateStatus('Saving results...');
        await ipcRenderer.invoke('save-excel', excelData);
        updateStatus('âœ… Results manually saved successfully');
      } catch (error) {
        showError(`Save failed: ${error.message}`);
      }
    });
    
    reloadBtn.addEventListener('click', () => loadExcelData());
    
    openExternalBtn.addEventListener('click', () => {
      const url = excelData[currentIndex] && excelData[currentIndex][columns.link];
      if (url) {
        shell.openExternal(url);
        updateStatus('Page opened in external browser');
      }
    });
    
    // Issue input event listener
    let issueInputTimeout;
    issueInput.addEventListener('input', (e) => {
      if (excelData[currentIndex]) {
        excelData[currentIndex][columns.issue] = e.target.value;
        updateStatus('Issue note updated');
        
        // Clear existing timeout
        clearTimeout(issueInputTimeout);
        
        // Auto-save after 1 second of no typing
        issueInputTimeout = setTimeout(() => {
          autoSave();
        }, 1000);
      }
    });
    
    // Auto-save issue on blur
    issueInput.addEventListener('blur', () => {
      updateStatus('Issue note saved');
      // Clear timeout and save immediately on blur
      clearTimeout(issueInputTimeout);
      autoSave();
    });
    
    // ä¿®æ”¹é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      // å¦‚æœç”¨æˆ·åœ¨è¾“å…¥æ¡†ä¸­ï¼Œä¸å“åº”å¿«æ·é”®ï¼ˆé™¤äº†Ctrl+Sï¼‰
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        if (e.key === 's' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          saveBtn.click();
        }
        return;
      }
      
      switch(e.key) {
        case 'ArrowLeft':
          if (!prevBtn.disabled) loadPage(currentIndex - 1);
          e.preventDefault();
          break;
        case 'ArrowRight':
          if (!nextBtn.disabled) loadPage(currentIndex + 1);
          e.preventDefault();
          break;
        case 'ArrowUp':
          // â†‘ ä»£è¡¨ Pass
          passBtn.click();
          e.preventDefault();
          break;
        case 'ArrowDown':
          // â†“ ä»£è¡¨ Fail
          failBtn.click();
          e.preventDefault();
          break;
        case 's':
          if (e.ctrlKey || e.metaKey) {
            saveBtn.click();
            e.preventDefault();
          }
          break;
      }
    });
    
    // æ·»åŠ çª—å£è°ƒæ•´äº‹ä»¶ç›‘å¬
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        adjustBrowserViewPosition();
      }, 250);
    });
    
    // æ·»åŠ æ»šåŠ¨äº‹ä»¶ç›‘å¬ï¼Œæ»šåŠ¨æ—¶éšè—BrowserView
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      ipcRenderer.invoke('hide-browser-view');
      
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        adjustBrowserViewPosition();
      }, 150);
    });
    
    // BrowserViewä½ç½®è°ƒæ•´å‡½æ•°
    function adjustBrowserViewPosition() {
      const rect = webFrame.getBoundingClientRect();
      ipcRenderer.invoke('adjust-browser-view', {
        x: Math.round(rect.left),
        y: Math.round(rect.top),
        width: Math.round(rect.width),
        height: Math.round(rect.height)
      });
    }
    
    // Utility functions
    function updateStatus(message) {
      statusEl.textContent = message;
      statusEl.style.backgroundColor = '#f2f2f2';
      statusEl.style.color = '#333';
    }
    
    function showError(message) {
      statusEl.textContent = message;
      statusEl.style.backgroundColor = '#ffebee';
      statusEl.style.color = '#c62828';
    }
    
    // Auto-save function
    async function autoSave() {
      if (excelData && excelData.length > 1) {
        try {
          await ipcRenderer.invoke('save-excel', excelData);
          console.log('Auto-saved data successfully');
          // æ˜¾ç¤ºç®€çŸ­çš„è‡ªåŠ¨ä¿å­˜æç¤º
          const originalText = statusEl.textContent;
          const originalBg = statusEl.style.backgroundColor;
          const originalColor = statusEl.style.color;
          
          statusEl.textContent = 'ğŸ’¾ Auto-saved';
          statusEl.style.backgroundColor = '#e8f5e8';
          statusEl.style.color = '#2e7d32';
          
          // 2ç§’åæ¢å¤åŸçŠ¶æ€
          setTimeout(() => {
            statusEl.textContent = originalText;
            statusEl.style.backgroundColor = originalBg;
            statusEl.style.color = originalColor;
          }, 2000);
        } catch (error) {
          console.error('Auto-save failed:', error);
          // ä¸æ˜¾ç¤ºé”™è¯¯ç»™ç”¨æˆ·ï¼Œå› ä¸ºè¿™æ˜¯è‡ªåŠ¨ä¿å­˜
        }
      }
    }
    
    // Initialize
    // loadExcelData(); // æ³¨é‡Šæ‰è‡ªåŠ¨åŠ è½½ï¼Œç°åœ¨ç”±æ–‡ä»¶é€‰æ‹©è§¦å‘
  </script>
</body>
</html> 