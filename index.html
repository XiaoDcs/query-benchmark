<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Page Scorer - Electron</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 15px;
      background-color: #f5f5f5;
      overflow-x: hidden;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: background-color 0.3s ease;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .nav-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .score-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .action-buttons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    button {
      padding: 8px 12px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #3367d6;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .score-button {
      padding: 10px 16px;
      font-weight: bold;
      font-size: 14px;
    }
    .pass {
      background-color: #34a853;
    }
    .pass:hover {
      background-color: #2e8b47;
    }
    .fail {
      background-color: #ea4335;
    }
    .fail:hover {
      background-color: #d33426;
    }
    .screenshot-top {
      background-color: #ff9800;
      padding: 8px 12px;
    }
    .screenshot-top:hover {
      background-color: #f57c00;
    }
    .content {
      display: flex;
      gap: 15px;
      height: calc(100vh - 100px); /* 减少顶部空间，从120px改为100px */
      min-height: 650px;
    }
    .web-view {
      flex: 1;
      min-width: 500px;
      display: flex;
      flex-direction: column;
    }
    .web-frame {
      width: 100%;
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 4px;
      height: 100%;
      min-height: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .sidebar {
      width: 320px;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 100%;
      overflow-y: auto;
    }
    .info-panel, .settings-panel, .issue-panel {
      background-color: #f9f9f9;
      padding: 12px;
      border-radius: 4px;
      flex-shrink: 0;
    }
    .progress-overview-panel {
      background-color: #f0f8ff;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid #b3d9ff;
      flex-shrink: 0;
    }
    .progress-overview-panel h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #1976d2;
    }
    .progress-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      padding: 8px;
      background-color: #ffffff;
      border-radius: 4px;
      border: 1px solid #e1f5fe;
    }
    .stat-item {
      font-size: 11px;
      font-weight: bold;
      text-align: center;
    }
    .progress-grid {
      display: grid;
      grid-template-columns: repeat(20, 1fr);
      gap: 2px;
      margin-bottom: 10px;
      padding: 8px;
      background-color: #ffffff;
      border-radius: 4px;
      border: 1px solid #e1f5fe;
      max-height: 200px;
      overflow-y: auto;
    }
    .progress-item {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .progress-item:hover {
      transform: scale(1.2);
      z-index: 10;
    }
    .progress-item.pass {
      background-color: #4caf50;
    }
    .progress-item.fail {
      background-color: #f44336;
    }
    .progress-item.pending {
      background-color: #e0e0e0;
      border: 1px solid #bdbdbd;
    }
    .progress-item.current {
      background-color: #2196f3;
      box-shadow: 0 0 6px rgba(33, 150, 243, 0.6);
    }
    .progress-legend {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-color {
      width: 8px;
      height: 8px;
      border-radius: 2px;
    }
    .legend-color.pass {
      background-color: #4caf50;
    }
    .legend-color.fail {
      background-color: #f44336;
    }
    .legend-color.pending {
      background-color: #e0e0e0;
      border: 1px solid #bdbdbd;
    }
    .legend-color.current {
      background-color: #2196f3;
    }
    .info-panel h3, .settings-panel h3, .issue-panel h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }
    .info-panel p {
      margin: 8px 0;
      font-size: 13px;
    }
    .status {
      margin-top: 10px;
      padding: 8px;
      background-color: #f2f2f2;
      border-radius: 4px;
      text-align: center;
      font-size: 12px;
      flex-shrink: 0;
    }
    .screenshot-preview {
      max-width: 100%;
      max-height: 120px;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
      font-size: 16px;
      color: #666;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      border-radius: 4px;
    }
    .hidden {
      display: none;
    }
    .url-display {
      word-break: break-all;
      color: #1a73e8;
      text-decoration: none;
      font-size: 12px;
    }
    .url-display:hover {
      text-decoration: underline;
    }
    .progress-bar {
      width: 100%;
      height: 4px;
      background-color: #e0e0e0;
      border-radius: 2px;
      margin: 8px 0;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background-color: #4285f4;
      transition: width 0.3s ease;
    }
    .web-container {
      position: relative;
      flex: 1;
    }
    
    /* 紧凑的缩略图容器 */
    #thumbnail-container {
      margin: 10px 0;
    }
    #thumbnail-container strong {
      font-size: 13px;
    }
    #thumbnail-preview, #thumbnail-placeholder {
      max-height: 80px;
      max-width: 100%;
      margin-top: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      display: block;
      cursor: pointer;
    }
    #thumbnail-placeholder {
      padding: 20px;
      background-color: #f5f5f5;
      text-align: center;
      color: #666;
      font-size: 12px;
    }
    
    /* 自动跳转开关样式 */
    .settings-panel {
      background-color: #f0f8ff;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid #b3d9ff;
      flex-shrink: 0;
    }
    .settings-panel h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #1976d2;
    }
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 8px 0;
    }
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background-color: #ccc;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .toggle-switch.active {
      background-color: #4285f4;
    }
    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background-color: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    .toggle-switch.active .toggle-slider {
      transform: translateX(26px);
    }
    .toggle-label {
      font-size: 13px;
      color: #333;
    }
    .preload-status {
      font-size: 11px;
      color: #666;
      margin-top: 8px;
      padding: 6px;
      background-color: #f8f9fa;
      border-radius: 3px;
    }
    .shortcuts-info {
      font-size: 11px;
      color: #666;
      margin-top: 8px;
      line-height: 1.4;
    }

    /* Issue标签相关样式 */
    .issue-panel {
      background-color: #fff3e0;
      border: 1px solid #ffcc80;
    }
    .issue-panel h3 {
      color: #f57c00;
    }
    .preset-tags {
      margin-bottom: 10px;
    }
    .preset-tag {
      display: inline-block;
      background-color: #e3f2fd;
      color: #1976d2;
      padding: 4px 8px;
      margin: 2px 4px 2px 0;
      border-radius: 12px;
      font-size: 11px;
      cursor: pointer;
      border: 1px solid #bbdefb;
      transition: all 0.2s;
    }
    .preset-tag:hover {
      background-color: #bbdefb;
    }
    .preset-tag.active {
      background-color: #2196f3;
      color: white;
    }
    .preset-tag.custom-tag {
      background-color: #f3e5f5;
      color: #7b1fa2;
      border-color: #ce93d8;
    }
    .preset-tag.custom-tag:hover {
      background-color: #ce93d8;
    }
    .add-tag-btn {
      display: inline-block;
      background-color: #e8f5e8;
      color: #2e7d32;
      padding: 4px 8px;
      margin: 2px 4px 2px 0;
      border-radius: 12px;
      font-size: 11px;
      cursor: pointer;
      border: 1px dashed #4caf50;
      transition: all 0.2s;
    }
    .add-tag-btn:hover {
      background-color: #c8e6c9;
    }
    .add-tag-input {
      margin: 8px 0;
      padding: 8px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
    }
    .add-tag-input input {
      width: 100%;
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .add-tag-input button {
      padding: 4px 12px;
      margin-right: 4px;
      font-size: 11px;
    }
    .edit-tag-input {
      margin: 8px 0;
      padding: 8px;
      background-color: #fff3e0;
      border: 1px solid #ffcc80;
      border-radius: 4px;
    }
    .edit-tag-input input {
      width: 100%;
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .edit-tag-input button {
      padding: 4px 12px;
      margin-right: 4px;
      font-size: 11px;
    }
    .tag-shortcuts {
      font-size: 10px;
      color: #666;
      margin-top: 5px;
      line-height: 1.3;
    }
    
    /* 移动端响应式 */
    @media (max-width: 900px) {
      .content {
        flex-direction: column;
        height: auto;
        min-height: auto;
      }
      .sidebar {
        width: 100%;
        min-width: auto;
        max-height: none;
      }
      .web-view {
        min-width: auto;
        height: 50vh;
        min-height: 400px;
      }
      .controls {
        flex-direction: column;
        gap: 8px;
      }
      .nav-buttons, .score-buttons, .action-buttons {
        justify-content: center;
        flex-wrap: wrap;
      }
    }

    /* 自定义快捷键配置样式 */
    .shortcuts-config {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 12px;
      margin-top: 10px;
    }
    .shortcuts-config h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #495057;
    }
    .shortcut-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #e9ecef;
      font-size: 11px;
    }
    .shortcut-item:last-child {
      border-bottom: none;
    }
    .shortcut-label {
      color: #495057;
      flex: 1;
    }
    .shortcut-key {
      background-color: #e9ecef;
      border: 1px solid #ced4da;
      border-radius: 3px;
      padding: 2px 6px;
      font-family: 'Courier New', monospace;
      font-size: 10px;
      min-width: 60px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .shortcut-key:hover {
      background-color: #dee2e6;
    }
    .shortcut-key.recording {
      background-color: #fff3cd;
      border-color: #ffeaa7;
      color: #856404;
    }
    .shortcut-key.conflict {
      background-color: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }
    .shortcuts-actions {
      margin-top: 10px;
      display: flex;
      gap: 5px;
    }
    .shortcuts-actions button {
      font-size: 10px;
      padding: 3px 8px;
    }
    .shortcut-help {
      font-size: 9px;
      color: #6c757d;
      margin-top: 5px;
      line-height: 1.3;
    }

    /* 容器状态背景色 */
    .container.status-unscored {
      background-color: white;
    }
    .container.status-pass {
      background-color: #e8f5e8;
    }
    .container.status-fail {
      background-color: #fde7e7;
    }

    /* 全屏图片查看器 */
    .fullscreen-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2147483647; /* 使用最大z-index值确保在所有内容之上 */
      cursor: pointer;
    }
    .fullscreen-image {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }
    
    /* Issue自动Fail开关样式 */
    .auto-fail-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0;
      font-size: 12px;
    }
    .toggle-switch {
      position: relative;
      width: 40px;
      height: 20px;
      background-color: #ccc;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .toggle-switch.active {
      background-color: #4CAF50;
    }
    .toggle-slider {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background-color: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    .toggle-switch.active .toggle-slider {
      transform: translateX(20px);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="controls">
      <div class="nav-buttons">
        <button id="file-btn">📁 Select Excel File</button>
        <button id="download-sample-btn">📥 Download Sample Excel</button>
        <button id="prev-btn" disabled>← Previous</button>
        <button id="next-btn" disabled>Next →</button>
        <button id="reload-btn" disabled>🔄 Reload</button>
      </div>
      <div class="score-buttons">
        <button id="pass-btn" class="score-button pass" disabled>✅ Pass (↑)</button>
        <button id="fail-btn" class="score-button fail" disabled>❌ Fail (↓)</button>
        <button id="screenshot-btn" class="screenshot-top" disabled>📸 Screenshot</button>
      </div>
      <div class="action-buttons">
        <button id="save-btn" disabled>💾 Save</button>
        <button id="open-external-btn" disabled>🔗 Open in Browser</button>
      </div>
    </div>
    
    <div class="content">
      <div class="web-view">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
        <div class="web-container">
          <div id="web-frame" class="web-frame">
            <div style="text-align: center; color: #666; padding: 20px;">
              <div style="font-size: 48px; margin-bottom: 20px;">📄</div>
              <div style="font-size: 18px; margin-bottom: 10px;">Please select an Excel file to start</div>
              <div style="font-size: 14px; color: #999;">Click "Select Excel File" button above</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="sidebar">
        <div class="info-panel">
          <h3>📋 Page Information</h3>
          <p><strong>Progress:</strong> <span id="page-counter">-</span></p>
          <p><strong>Query:</strong> <span id="current-query">-</span></p>
          <p><strong>URL:</strong> <a href="#" id="current-url" class="url-display" target="_blank">-</a></p>
          <p><strong>Current Score:</strong> <span id="current-score">Not scored</span></p>
          
          <div id="thumbnail-container">
            <strong>Thumbnail:</strong>
            <img id="thumbnail-preview" class="hidden" alt="Thumbnail" />
            <div id="thumbnail-placeholder">No thumbnail available</div>
          </div>
        </div>
        
        <div class="progress-overview-panel">
          <h3>📊 Progress Overview</h3>
          <div class="progress-stats">
            <span class="stat-item">✅ <span id="pass-count">0</span></span>
            <span class="stat-item">❌ <span id="fail-count">0</span></span>
            <span class="stat-item">⏸️ <span id="pending-count">0</span></span>
            <span class="stat-item">📋 <span id="total-count">0</span></span>
          </div>
          <div class="progress-grid" id="progress-grid">
            <!-- 进度方块将通过JavaScript动态生成 -->
          </div>
          <div class="progress-legend">
            <span class="legend-item"><span class="legend-color pass"></span>Pass</span>
            <span class="legend-item"><span class="legend-color fail"></span>Fail</span>
            <span class="legend-item"><span class="legend-color pending"></span>Pending</span>
            <span class="legend-item"><span class="legend-color current"></span>Current</span>
          </div>
        </div>
        
        <div class="issue-panel">
          <h3>📝 Issue Notes</h3>
          
          <!-- 预设标签区域 -->
          <div class="preset-tags" id="preset-tags-container">
            <!-- 标签将通过JavaScript动态生成 -->
            <span class="add-tag-btn" id="add-tag-btn" title="Add custom tag">+ Add Tag</span>
          </div>
          
          <div class="tag-shortcuts">
            <strong>Quick tags:</strong> Ctrl+1~9 for tags, Ctrl+0 to clear<br>
            <strong>Edit tags:</strong> Double-click to edit, right-click custom tags to delete
          </div>
          
          <!-- 添加自定义标签的输入框 -->
          <div class="add-tag-input hidden" id="add-tag-input">
            <input type="text" id="new-tag-input" placeholder="Enter new tag name..." maxlength="20">
            <button id="save-tag-btn">Save</button>
            <button id="cancel-tag-btn">Cancel</button>
          </div>
          
          <!-- 编辑标签的输入框 -->
          <div class="edit-tag-input hidden" id="edit-tag-input">
            <input type="text" id="edit-tag-text" placeholder="Edit tag name..." maxlength="20">
            <button id="save-edit-btn">Save</button>
            <button id="cancel-edit-btn">Cancel</button>
          </div>
          
          <textarea id="issue-input" rows="3" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 8px; resize: vertical; margin-top: 8px; font-size: 13px; box-sizing: border-box;" placeholder="Enter issue or note..."></textarea>
          
          <div style="margin-top: 10px;">
            <img id="screenshot-preview" class="screenshot-preview hidden" alt="Screenshot" />
            <div id="no-screenshot" style="text-align: center; padding: 20px; background-color: #f5f5f5; border: 1px dashed #ccc; border-radius: 4px; color: #666; font-size: 12px;">
              📷 No screenshot taken
            </div>
          </div>
        </div>
        
        <div class="settings-panel">
          <h3>⚙️ Settings</h3>
          
          <!-- Auto-advance setting -->
          <div class="toggle-container">
            <div class="toggle-switch" id="auto-next-toggle">
              <div class="toggle-slider"></div>
            </div>
            <label class="toggle-label">Auto-advance on Pass</label>
          </div>
          
          <!-- Auto-fail on issue setting -->
          <div class="toggle-container">
            <div class="toggle-switch" id="auto-fail-toggle">
              <div class="toggle-slider"></div>
            </div>
            <label class="toggle-label">Auto-fail when Issue added</label>
          </div>
          
          <!-- Preload count setting -->
          <div style="margin: 10px 0;">
            <label for="preload-count" style="display: block; margin-bottom: 5px; font-size: 13px; color: #333;">Preload pages:</label>
            <select id="preload-count" style="width: 100%; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
              <option value="0">Disabled</option>
              <option value="3">3 pages</option>
              <option value="5" selected>5 pages</option>
              <option value="10">10 pages</option>
              <option value="15">15 pages</option>
            </select>
          </div>
          
          <!-- Page jump -->
          <div style="margin: 10px 0;">
            <label for="page-jump" style="display: block; margin-bottom: 5px; font-size: 13px; color: #333;">Jump to page:</label>
            <div style="display: flex; gap: 5px;">
              <input type="number" id="page-jump" min="1" max="1" value="1" style="flex: 1; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;" placeholder="Page #">
              <button id="jump-btn" style="padding: 4px 12px; font-size: 12px;">Go</button>
            </div>
          </div>
          
          <div class="preload-status" id="preload-status">
            Preloading: Ready
          </div>
          
          <div class="shortcuts-info">
            <strong>Shortcuts:</strong><br>
            ↑ Pass (saves as 1)<br>
            ↓ Fail (saves as 0)<br>
            Ctrl+S Save manually
          </div>
          
          <!-- 自定义快捷键配置 -->
          <div style="margin-top: 10px;">
            <button id="toggle-shortcuts-btn" style="background-color: #6c757d; width: 100%;">⌨️ Custom Shortcuts</button>
          </div>
          
          <div class="shortcuts-config" id="shortcuts-config-panel">
            <h4>⌨️ Custom Shortcuts</h4>
            <div id="shortcuts-list">
              <!-- 快捷键列表将由JavaScript生成 -->
            </div>
            <div class="shortcuts-actions">
              <button id="reset-shortcuts-btn">Reset All</button>
            </div>
            <div class="shortcut-help">
              Click any shortcut to edit. Press ESC to cancel recording.
            </div>
          </div>
        </div>
        
        <div class="status" id="status">Ready to start</div>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer, shell } = require('electron');
    
    // 监听来自主进程的全局快捷键事件
    ipcRenderer.on('global-shortcut', (event, action, param) => {
      handleGlobalShortcut(action, param);
    });
    
    // 处理全局快捷键
    function handleGlobalShortcut(action, param) {
      switch (action) {
        case 'pass':
          if (!passBtn.disabled) passBtn.click();
          break;
        case 'fail':
          if (!failBtn.disabled) failBtn.click();
          break;
        case 'save':
          saveBtn.click();
          break;
        case 'reload':
          if (!reloadBtn.disabled) reloadBtn.click();
          break;
        case 'previous':
          if (!prevBtn.disabled) prevBtn.click();
          break;
        case 'next':
          if (!nextBtn.disabled) nextBtn.click();
          break;
        case 'tag':
          // param是标签序号 (1-9)
          if (param && param >= 1 && param <= 9) {
            const targetTag = document.querySelector(`[data-shortcut="${param}"]`);
            if (targetTag) {
              appendIssueTag(targetTag.dataset.tag);
              // 视觉反馈
              targetTag.classList.add('active');
              setTimeout(() => targetTag.classList.remove('active'), 200);
            }
          }
          break;
        case 'clear-tags':
          clearIssueInput();
          break;
        default:
          console.log('Unknown global shortcut:', action);
      }
    }
    
    // DOM elements
    const fileBtn = document.getElementById('file-btn');
    const downloadSampleBtn = document.getElementById('download-sample-btn');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const passBtn = document.getElementById('pass-btn');
    const failBtn = document.getElementById('fail-btn');
    const screenshotBtn = document.getElementById('screenshot-btn');
    const saveBtn = document.getElementById('save-btn');
    const reloadBtn = document.getElementById('reload-btn');
    const openExternalBtn = document.getElementById('open-external-btn');
    const webFrame = document.getElementById('web-frame');
    const pageCounterEl = document.getElementById('page-counter');
    const currentQueryEl = document.getElementById('current-query');
    const currentUrlEl = document.getElementById('current-url');
    const currentScoreEl = document.getElementById('current-score');
    const issueInput = document.getElementById('issue-input');
    const screenshotPreview = document.getElementById('screenshot-preview');
    const noScreenshotDiv = document.getElementById('no-screenshot');
    const statusEl = document.getElementById('status');
    const progressFill = document.getElementById('progress-fill');
    const thumbnailPreview = document.getElementById('thumbnail-preview');
    const thumbnailPlaceholder = document.getElementById('thumbnail-placeholder');
    const autoNextToggle = document.getElementById('auto-next-toggle');
    const autoFailToggle = document.getElementById('auto-fail-toggle');
    const preloadStatusEl = document.getElementById('preload-status');
    const preloadCountSelect = document.getElementById('preload-count');
    const pageJumpInput = document.getElementById('page-jump');
    const jumpBtn = document.getElementById('jump-btn');
    const addTagBtn = document.getElementById('add-tag-btn');
    const addTagInput = document.getElementById('add-tag-input');
    const newTagInput = document.getElementById('new-tag-input');
    const saveTagBtn = document.getElementById('save-tag-btn');
    const cancelTagBtn = document.getElementById('cancel-tag-btn');
    const editTagInput = document.getElementById('edit-tag-input');
    const editTagText = document.getElementById('edit-tag-text');
    const saveEditBtn = document.getElementById('save-edit-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const presetTagsContainer = document.getElementById('preset-tags-container');
    const shortcutsList = document.getElementById('shortcuts-list');
    const resetShortcutsBtn = document.getElementById('reset-shortcuts-btn');
    const toggleShortcutsBtn = document.getElementById('toggle-shortcuts-btn');
    const shortcutsConfig = document.querySelector('.shortcuts-config');
    
    // Progress Overview elements
    const progressGrid = document.getElementById('progress-grid');
    const passCountEl = document.getElementById('pass-count');
    const failCountEl = document.getElementById('fail-count');
    const pendingCountEl = document.getElementById('pending-count');
    const totalCountEl = document.getElementById('total-count');
    
    // App state
    let excelData = [];
    let currentIndex = 1; // 从1开始，跳过标题行
    let columns = {};
    let autoNextEnabled = true; // 默认开启自动跳转
    let autoFailEnabled = false; // 默认关闭自动fail
    let preloadQueue = new Set(); // 预加载队列
    let preloadedPages = new Map(); // 预加载缓存
    let maxPreloadPages = 5; // 默认预加载5页
    let customTags = []; // 自定义标签数组
    let presetTags = []; // 预设标签数组（现在也可以编辑）
    let currentEditingTag = null; // 当前正在编辑的标签
    let customShortcuts = {}; // 自定义快捷键配置
    let recordingShortcut = null; // 当前正在录制的快捷键
    let shortcutsVisible = false; // 快捷键配置面板可见性
    
    // 默认预设标签
    const defaultPresetTags = [
      '有争议性',
      '涉及敏感话题', 
      '过于主观评价',
      '负面语言',
      '过于标题党',
      '挑战政策/制度',
      '图片无法加载'
    ];
    
    // 默认快捷键配置
    const defaultShortcuts = {
      'previous': { keys: ['ArrowLeft'], description: 'Previous Page' },
      'next': { keys: ['ArrowRight'], description: 'Next Page' },
      'pass': { keys: ['ArrowUp'], description: 'Mark as Pass' },
      'fail': { keys: ['ArrowDown'], description: 'Mark as Fail' },
      'save': { keys: ['Control', 's'], description: 'Save Manually' },
      'screenshot': { keys: ['Control', 'p'], description: 'Take Screenshot' },
      'reload': { keys: ['F5'], description: 'Reload Page' },
      'openExternal': { keys: ['Control', 'o'], description: 'Open in Browser' },
      'clearTags': { keys: ['Control', '0'], description: 'Clear Issue Tags' },
      'toggleAutoNext': { keys: ['Control', 'a'], description: 'Toggle Auto-advance' },
      'focusJump': { keys: ['Control', 'g'], description: 'Focus Page Jump' }
    };
    
    // 初始化自定义快捷键系统
    function initCustomShortcuts() {
      // 从localStorage加载自定义快捷键
      const savedShortcuts = localStorage.getItem('customShortcuts');
      if (savedShortcuts) {
        try {
          const parsed = JSON.parse(savedShortcuts);
          customShortcuts = { ...defaultShortcuts, ...parsed };
        } catch (e) {
          console.error('Failed to load custom shortcuts:', e);
          customShortcuts = { ...defaultShortcuts };
        }
      } else {
        customShortcuts = { ...defaultShortcuts };
      }
      
      renderShortcutsList();
      updateShortcutsInfo();
    }
    
    // 渲染快捷键列表
    function renderShortcutsList() {
      if (!shortcutsList) return;
      
      shortcutsList.innerHTML = '';
      
      Object.entries(customShortcuts).forEach(([action, config]) => {
        const item = document.createElement('div');
        item.className = 'shortcut-item';
        
        const label = document.createElement('div');
        label.className = 'shortcut-label';
        label.textContent = config.description;
        
        const keyDisplay = document.createElement('div');
        keyDisplay.className = 'shortcut-key';
        keyDisplay.textContent = formatShortcutDisplay(config.keys);
        keyDisplay.dataset.action = action;
        keyDisplay.title = 'Click to edit';
        
        keyDisplay.addEventListener('click', () => startRecordingShortcut(action, keyDisplay));
        
        item.appendChild(label);
        item.appendChild(keyDisplay);
        shortcutsList.appendChild(item);
      });
    }
    
    // 格式化快捷键显示
    function formatShortcutDisplay(keys) {
      if (!keys || keys.length === 0) return 'None';
      
      return keys.map(key => {
        switch(key) {
          case 'Control': return 'Ctrl';
          case 'ArrowLeft': return '←';
          case 'ArrowRight': return '→';
          case 'ArrowUp': return '↑';
          case 'ArrowDown': return '↓';
          case ' ': return 'Space';
          default: return key;
        }
      }).join('+');
    }
    
    // 开始录制快捷键
    function startRecordingShortcut(action, keyElement) {
      if (recordingShortcut) {
        cancelRecordingShortcut();
      }
      
      recordingShortcut = { action, element: keyElement, keys: [] };
      keyElement.classList.add('recording');
      keyElement.textContent = 'Press keys...';
      updateStatus(`Recording shortcut for: ${customShortcuts[action].description}`);
    }
    
    // 取消录制快捷键
    function cancelRecordingShortcut() {
      if (!recordingShortcut) return;
      
      recordingShortcut.element.classList.remove('recording', 'conflict');
      recordingShortcut.element.textContent = formatShortcutDisplay(customShortcuts[recordingShortcut.action].keys);
      recordingShortcut = null;
      updateStatus('Shortcut recording cancelled');
    }
    
    // 保存录制的快捷键
    function saveRecordedShortcut(keys) {
      if (!recordingShortcut || keys.length === 0) return;
      
      const { action, element } = recordingShortcut;
      
      // 检查冲突
      const conflictAction = findShortcutConflict(keys, action);
      if (conflictAction) {
        element.classList.add('conflict');
        element.textContent = `Conflict with: ${customShortcuts[conflictAction].description}`;
        updateStatus(`Shortcut conflicts with: ${customShortcuts[conflictAction].description}`);
        setTimeout(() => {
          element.classList.remove('conflict');
          element.textContent = formatShortcutDisplay(keys);
        }, 2000);
        return;
      }
      
      // 保存新快捷键
      customShortcuts[action].keys = [...keys];
      saveCustomShortcuts();
      
      element.classList.remove('recording');
      element.textContent = formatShortcutDisplay(keys);
      recordingShortcut = null;
      
      updateStatus(`Shortcut updated for: ${customShortcuts[action].description}`);
      updateShortcutsInfo();
    }
    
    // 查找快捷键冲突
    function findShortcutConflict(keys, excludeAction) {
      const keyString = keys.sort().join('+');
      
      for (const [action, config] of Object.entries(customShortcuts)) {
        if (action === excludeAction) continue;
        if (config.keys.sort().join('+') === keyString) {
          return action;
        }
      }
      
      return null;
    }
    
    // 保存自定义快捷键到localStorage
    function saveCustomShortcuts() {
      localStorage.setItem('customShortcuts', JSON.stringify(customShortcuts));
    }
    
    // 重置所有快捷键
    function resetAllShortcuts() {
      if (confirm('Reset all shortcuts to default? This cannot be undone.')) {
        customShortcuts = { ...defaultShortcuts };
        saveCustomShortcuts();
        renderShortcutsList();
        updateShortcutsInfo();
        updateStatus('All shortcuts reset to default');
      }
    }
    
    // 更新快捷键信息显示
    function updateShortcutsInfo() {
      const shortcutsInfo = document.querySelector('.shortcuts-info');
      if (shortcutsInfo) {
        shortcutsInfo.innerHTML = `
          <strong>Current Shortcuts:</strong><br>
          ${formatShortcutDisplay(customShortcuts.pass.keys)} Pass<br>
          ${formatShortcutDisplay(customShortcuts.fail.keys)} Fail<br>
          ${formatShortcutDisplay(customShortcuts.save.keys)} Save<br>
          <em>Click "Custom Shortcuts" below to edit all shortcuts</em>
        `;
      }
    }
    
    // 初始化标签系统
    function initTagSystem() {
      // 从localStorage加载预设标签
      const savedPresetTags = localStorage.getItem('presetTags');
      if (savedPresetTags) {
        try {
          presetTags = JSON.parse(savedPresetTags);
        } catch (e) {
          console.error('Failed to load preset tags:', e);
          presetTags = [...defaultPresetTags];
        }
      } else {
        presetTags = [...defaultPresetTags];
      }
      
      // 从localStorage加载自定义标签
      const savedCustomTags = localStorage.getItem('customTags');
      if (savedCustomTags) {
        try {
          customTags = JSON.parse(savedCustomTags);
        } catch (e) {
          console.error('Failed to load custom tags:', e);
          customTags = [];
        }
      }
      
      renderAllTags();
    }
    
    // 渲染所有标签
    function renderAllTags() {
      // 清空容器（但保留Add Tag按钮）
      const existingTags = presetTagsContainer.querySelectorAll('.preset-tag');
      existingTags.forEach(tag => tag.remove());
      
      // 渲染预设标签
      presetTags.forEach((tagText, index) => {
        const tag = createTagElement(tagText, index + 1, 'preset');
        presetTagsContainer.insertBefore(tag, addTagBtn);
      });
      
      // 渲染自定义标签
      customTags.forEach((tagText, index) => {
        const shortcut = presetTags.length + index + 1;
        if (shortcut <= 9) { // 只有前9个标签支持快捷键
          const tag = createTagElement(tagText, shortcut, 'custom');
          presetTagsContainer.insertBefore(tag, addTagBtn);
        } else {
          const tag = createTagElement(tagText, null, 'custom');
          presetTagsContainer.insertBefore(tag, addTagBtn);
        }
      });
    }
    
    // 创建标签元素
    function createTagElement(tagText, shortcut, type) {
      const tag = document.createElement('span');
      tag.className = type === 'preset' ? 'preset-tag' : 'preset-tag custom-tag';
      tag.textContent = tagText;
      tag.dataset.tag = tagText;
      tag.dataset.type = type;
      
      if (shortcut) {
        tag.dataset.shortcut = shortcut;
        tag.title = `Ctrl+${shortcut} to use${type === 'preset' ? ', double-click to edit' : ', right-click to delete'}`;
      } else {
        tag.title = type === 'preset' ? 'Double-click to edit' : 'Right-click to delete (no shortcut)';
      }
      
      // 左键点击添加标签
      tag.addEventListener('click', () => {
        appendIssueTag(tagText);
      });
      
      // 双击编辑标签
      tag.addEventListener('dblclick', (e) => {
        e.preventDefault();
        startEditingTag(tag, tagText, type);
      });
      
      // 右键删除自定义标签
      if (type === 'custom') {
        tag.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          if (confirm(`Delete custom tag "${tagText}"?`)) {
            deleteCustomTag(tagText);
          }
        });
      }
      
      return tag;
    }
    
    // 开始编辑标签
    function startEditingTag(tagElement, currentText, type) {
      currentEditingTag = { element: tagElement, text: currentText, type: type };
      editTagText.value = currentText;
      editTagInput.classList.remove('hidden');
      editTagText.focus();
      editTagText.select();
    }
    
    // 保存编辑的标签
    function saveEditedTag() {
      if (!currentEditingTag) return;
      
      const newText = editTagText.value.trim();
      if (!newText) {
        updateStatus('Tag name cannot be empty');
        return;
      }
      
      if (newText.length > 20) {
        updateStatus('Tag name too long (max 20 characters)');
        return;
      }
      
      const { text: oldText, type } = currentEditingTag;
      
      // 检查是否与其他标签重复
      const allTags = [...presetTags, ...customTags];
      if (allTags.includes(newText) && newText !== oldText) {
        updateStatus('Tag name already exists');
        return;
      }
      
      if (type === 'preset') {
        const index = presetTags.indexOf(oldText);
        if (index !== -1) {
          presetTags[index] = newText;
          savePresetTags();
          updateStatus(`Preset tag "${oldText}" updated to "${newText}"`);
        }
      } else {
        const index = customTags.indexOf(oldText);
        if (index !== -1) {
          customTags[index] = newText;
          saveCustomTags();
          updateStatus(`Custom tag "${oldText}" updated to "${newText}"`);
        }
      }
      
      renderAllTags();
      cancelEditingTag();
    }
    
    // 取消编辑标签
    function cancelEditingTag() {
      currentEditingTag = null;
      editTagText.value = '';
      editTagInput.classList.add('hidden');
    }
    
    // 保存预设标签到localStorage
    function savePresetTags() {
      localStorage.setItem('presetTags', JSON.stringify(presetTags));
    }
    
    // 初始化自定义标签
    function initCustomTags() {
      // 这个函数现在由initTagSystem()处理
    }
    
    // 渲染自定义标签
    function renderCustomTags() {
      // 这个函数现在由renderAllTags()处理
    }
    
    // 保存自定义标签到localStorage
    function saveCustomTags() {
      localStorage.setItem('customTags', JSON.stringify(customTags));
    }
    
    // 添加自定义标签
    function addCustomTag(tagText) {
      if (!tagText || tagText.trim() === '') return;
      
      tagText = tagText.trim();
      
      // 检查是否已存在
      const allTags = [...presetTags, ...customTags];
      if (allTags.includes(tagText)) {
        updateStatus('Tag already exists');
        return;
      }
      
      // 检查长度限制
      if (tagText.length > 20) {
        updateStatus('Tag name too long (max 20 characters)');
        return;
      }
      
      customTags.push(tagText);
      saveCustomTags();
      renderAllTags();
      updateStatus(`Custom tag "${tagText}" added`);
    }
    
    // 删除自定义标签
    function deleteCustomTag(tagText) {
      const index = customTags.indexOf(tagText);
      if (index !== -1) {
        customTags.splice(index, 1);
        saveCustomTags();
        renderAllTags();
        updateStatus(`Custom tag "${tagText}" deleted`);
      }
    }
    
    // 预加载逻辑
    function startPreloading() {
      // 清空之前的预加载
      preloadQueue.clear();
      preloadedPages.clear();
      
      // 预加载当前页面后的页面
      preloadNextPages();
    }
    
    function preloadNextPages() {
      if (!excelData || excelData.length <= 1 || maxPreloadPages === 0) {
        updatePreloadStatus('Preloading disabled');
        return;
      }
      
      let preloadCount = 0;
      const dataLength = excelData.length; // 包含标题行的总长度
      const maxDataIndex = dataLength - 1; // 最后一行数据的索引
      
      for (let i = currentIndex + 1; i <= Math.min(currentIndex + maxPreloadPages, maxDataIndex); i++) {
        if (!preloadedPages.has(i) && !preloadQueue.has(i)) {
          // 检查这一行是否有有效的URL
          const rowData = excelData[i];
          const url = rowData && rowData[columns.link];
          if (url && url.trim() && url.startsWith('http')) {
            preloadQueue.add(i);
            preloadCount++;
          }
        }
      }
      
      if (preloadCount > 0) {
        updatePreloadStatus(`Preloading ${preloadCount} pages...`);
        processPreloadQueue();
      } else {
        updatePreloadStatus(`${preloadedPages.size} pages preloaded`);
      }
    }
    
    async function processPreloadQueue() {
      if (preloadQueue.size === 0) return;
      
      const pageIndex = preloadQueue.values().next().value;
      preloadQueue.delete(pageIndex);
      
      try {
        const rowData = excelData[pageIndex];
        const url = rowData && rowData[columns.link];
        
        if (url && url.trim() && url.startsWith('http')) {
          // 在后台预加载URL
          const result = await ipcRenderer.invoke('preload-url', url);
          if (result.success) {
            preloadedPages.set(pageIndex, {
              url: url,
              loaded: true,
              timestamp: Date.now()
            });
            console.log(`Successfully preloaded page ${pageIndex}: ${url}`);
          }
        }
      } catch (error) {
        console.log(`Preload failed for page ${pageIndex}:`, error);
      }
      
      // 继续处理队列中的下一个
      if (preloadQueue.size > 0) {
        setTimeout(() => processPreloadQueue(), 200); // 增加间隔到200ms减少卡顿
      } else {
        updatePreloadStatus(`${preloadedPages.size} pages preloaded`);
      }
    }
    
    function updatePreloadStatus(message) {
      preloadStatusEl.textContent = message;
    }
    
    // Load specific page
    function loadPage(index) {
      if (!excelData || excelData.length <= 1) return;
      
      // Auto-save previous page when navigating
      if (currentIndex !== index) {
        autoSave();
      }
      
      const maxIndex = excelData.length - 1;
      currentIndex = Math.max(1, Math.min(index, maxIndex)); // 确保不小于1（跳过标题行）
      
      // Update page jump input value
      pageJumpInput.value = currentIndex;
      
      // Update navigation buttons
      prevBtn.disabled = currentIndex <= 1; // 第一页是索引1
      nextBtn.disabled = currentIndex >= maxIndex;
      
      // Update progress (基于实际数据页数，不包括标题行)
      const totalDataPages = maxIndex; // 总数据页数
      const currentDataPage = currentIndex; // 当前数据页
      const progress = totalDataPages > 0 ? (currentDataPage / totalDataPages) * 100 : 0;
      progressFill.style.width = `${progress}%`;
      
      const rowData = excelData[currentIndex];
      if (!rowData) return;
      
      // Update page counter (显示给用户的页码，从1开始)
      pageCounterEl.textContent = `${currentIndex}/${maxIndex}`;
      
      // Load query data
      const queryData = rowData[columns.description] || rowData[columns.query] || 'N/A';
      currentQueryEl.textContent = queryData;
      
      // Load URL
      const url = rowData[columns.link];
      if (url) {
        currentUrlEl.textContent = url;
        currentUrlEl.href = url;
      } else {
        currentUrlEl.textContent = 'No URL available';
        currentUrlEl.href = '#';
      }
      
      // Load score data
      const resultData = rowData[columns.result];
      if (resultData === 1) {
        currentScoreEl.textContent = '✅ Passed (1)';
        currentScoreEl.style.color = '#388e3c';
        updateContainerStatus(1);
      } else if (resultData === 0) {
        currentScoreEl.textContent = '❌ Failed (0)';
        currentScoreEl.style.color = '#d32f2f';
        updateContainerStatus(0);
      } else {
        currentScoreEl.textContent = 'Not scored';
        currentScoreEl.style.color = '#666';
        updateContainerStatus(null);
      }
      
      // Load thumbnail
      const thumbnailUrl = rowData[columns.thumbnail_link];
      if (thumbnailUrl) {
        thumbnailPreview.src = thumbnailUrl;
        thumbnailPreview.classList.remove('hidden');
        thumbnailPlaceholder.style.display = 'none';
        thumbnailPreview.onerror = () => {
          thumbnailPreview.classList.add('hidden');
          thumbnailPlaceholder.style.display = 'block';
        };
      } else {
        thumbnailPreview.classList.add('hidden');
        thumbnailPlaceholder.style.display = 'block';
      }
      
      // Load screenshot data
      const screenshotData = rowData[columns.screenshot];
      if (screenshotData) {
        if (screenshotData.startsWith('screenshots/') || screenshotData.includes('/')) {
          // File path - load from file
          ipcRenderer.invoke('load-screenshot', screenshotData).then(result => {
            if (result.success) {
              const imgSrc = `data:image/png;base64,${result.data}`;
              screenshotPreview.src = imgSrc;
              screenshotPreview.classList.remove('hidden');
              noScreenshotDiv.style.display = 'none';
              screenshotPreview.onclick = () => {
                const newWindow = window.open();
                newWindow.document.write(`<img src="${imgSrc}" style="max-width: 100%; max-height: 100vh; object-fit: contain;">`);
              };
            } else {
              screenshotPreview.classList.add('hidden');
              noScreenshotDiv.style.display = 'flex';
            }
          });
        } else {
          // Legacy base64 without data prefix
          const imgSrc = `data:image/png;base64,${screenshotData}`;
          screenshotPreview.src = imgSrc;
          screenshotPreview.classList.remove('hidden');
          noScreenshotDiv.style.display = 'none';
          screenshotPreview.onclick = () => {
            const newWindow = window.open();
            newWindow.document.write(`<img src="${imgSrc}" style="max-width: 100%; max-height: 100vh; object-fit: contain;">`);
          };
        }
      } else {
        screenshotPreview.classList.add('hidden');
        noScreenshotDiv.style.display = 'flex';
        screenshotPreview.onclick = null;
      }
      
      // Load issue data
      const issueData = rowData[columns.issue] || '';
      issueInput.value = issueData;
      
      // Load URL in webview
      if (url && url.trim() && url.startsWith('http')) {
        // 检查是否已预加载
        if (preloadedPages.has(currentIndex)) {
          updateStatus(`Loading: ${url} (preloaded)`);
          webFrame.innerHTML = '<div style="text-align: center; padding: 20px; color: #4285f4;"><div style="margin-bottom: 10px;">⚡ Preloaded website loaded instantly</div><div style="font-size: 12px; color: #666;">You can see the actual website content in the embedded browser view</div></div>';
        } else {
          updateStatus(`Loading: ${url}`);
          webFrame.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">🔄 Loading website...</div>';
        }
        
        // Adjust BrowserView position first
        adjustBrowserViewPosition();
        
        // Use IPC to load URL in BrowserView
        ipcRenderer.invoke('load-url', url).then(result => {
          if (result.success) {
            webFrame.innerHTML = '<div style="text-align: center; padding: 20px; color: #4285f4;"><div style="margin-bottom: 10px;">✅ Website loaded in the view above</div><div style="font-size: 12px; color: #666;">You can see the actual website content in the embedded browser view</div></div>';
            updateStatus('Website loaded successfully');
          } else {
            webFrame.innerHTML = `
              <div style="text-align: center; padding: 20px; color: #d32f2f;">
                <div style="margin-bottom: 15px;">⚠️ Website could not be embedded</div>
                <div style="font-size: 12px; color: #666; margin-bottom: 15px;">
                  This is common with some websites due to security restrictions.<br/>
                  You can still use the "Open in Browser" button below to view it.
                </div>
                <div style="font-size: 11px; color: #999;">Error: ${result.error}</div>
              </div>
            `;
            updateStatus(`Failed to load website: ${result.error}`);
          }
        }).catch(error => {
          webFrame.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #d32f2f;">
              <div style="margin-bottom: 15px;">❌ Loading Error</div>
              <div style="font-size: 12px; color: #666; margin-bottom: 15px;">
                There was an error loading this website.<br/>
                You can still score it and use "Open in Browser" to view it externally.
              </div>
              <div style="font-size: 11px; color: #999;">Error: ${error.message}</div>
            </div>
          `;
          updateStatus(`Error loading website: ${error.message}`);
        });
      } else {
        webFrame.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">📝 No valid URL available for this entry</div>';
        updateStatus('No valid URL available');
      }
      
      // 触发下一批预加载
      preloadNextPages();
      
      // 更新Progress Overview
      updateProgressOverview();
    }
    
    // Event listeners
    prevBtn.addEventListener('click', () => loadPage(currentIndex - 1));
    nextBtn.addEventListener('click', () => loadPage(currentIndex + 1));
    
    // 修改Pass按钮行为，支持自动跳转
    passBtn.addEventListener('click', () => {
      excelData[currentIndex][columns.result] = 1;
      currentScoreEl.textContent = '✅ Passed (1)';
      currentScoreEl.style.color = '#388e3c';
      updateContainerStatus(1);
      updateStatus('Marked as Passed');
      // Auto-save after scoring
      autoSave();
      
      // 更新Progress Overview
      updateProgressOverview();
      
      // 自动跳转到下一页（如果开启了自动跳转）
      if (autoNextEnabled && currentIndex < excelData.length - 1) {
        setTimeout(() => {
          loadPage(currentIndex + 1);
        }, 300); // 300ms延迟让用户看到反馈
      }
    });
    
    failBtn.addEventListener('click', () => {
      excelData[currentIndex][columns.result] = 0;
      currentScoreEl.textContent = '❌ Failed (0)';
      currentScoreEl.style.color = '#d32f2f';
      updateContainerStatus(0);
      updateStatus('Marked as Failed');
      // Auto-save after scoring
      autoSave();
      
      // 更新Progress Overview
      updateProgressOverview();
    });
    
    screenshotBtn.addEventListener('click', async () => {
      try {
        updateStatus('Taking screenshot...');
        const result = await ipcRenderer.invoke('take-screenshot');
        
        if (result.success) {
          // Use base64 for immediate display
          const screenshotData = `data:image/png;base64,${result.screenshot}`;
          screenshotPreview.src = screenshotData;
          screenshotPreview.classList.remove('hidden');
          noScreenshotDiv.style.display = 'none';
          
          // Save file path to Excel (not base64 to avoid character limit)
          excelData[currentIndex][columns.screenshot] = result.filepath;
          
          screenshotPreview.onclick = () => {
            const newWindow = window.open();
            newWindow.document.write(`<img src="${screenshotData}" style="max-width: 100%; max-height: 100vh; object-fit: contain;">`);
          };
          
          updateStatus('Screenshot taken and saved successfully');
          // Auto-save after taking screenshot
          autoSave();
        } else {
          showError('Failed to take screenshot');
        }
      } catch (error) {
        showError(`Screenshot failed: ${error.message}`);
      }
    });
    
    saveBtn.addEventListener('click', async () => {
      try {
        updateStatus('Saving results...');
        await ipcRenderer.invoke('save-excel', excelData);
        updateStatus('✅ Results manually saved successfully');
      } catch (error) {
        showError(`Save failed: ${error.message}`);
      }
    });
    
    reloadBtn.addEventListener('click', () => loadExcelData());
    
    openExternalBtn.addEventListener('click', () => {
      const url = excelData[currentIndex] && excelData[currentIndex][columns.link];
      if (url) {
        shell.openExternal(url);
        updateStatus('Page opened in external browser');
      }
    });
    
    // Issue input event listener
    let issueInputTimeout;
    issueInput.addEventListener('input', (e) => {
      if (excelData[currentIndex]) {
        excelData[currentIndex][columns.issue] = e.target.value;
        updateStatus('Issue note updated');
        
        // 检查自动fail功能
        if (autoFailEnabled) {
          const issueText = e.target.value.trim();
          if (issueText && excelData[currentIndex][columns.result] !== 0) {
            // 有issue内容且当前不是fail状态，自动设为fail
            excelData[currentIndex][columns.result] = 0;
            currentScoreEl.textContent = '❌ Failed (0)';
            currentScoreEl.style.color = '#d32f2f';
            updateContainerStatus(0);
            updateStatus('Auto-failed due to issue content');
            
            // 更新Progress Overview
            updateProgressOverview();
          }
        }
        
        // Clear existing timeout
        clearTimeout(issueInputTimeout);
        
        // Auto-save after 1 second of no typing
        issueInputTimeout = setTimeout(() => {
          autoSave();
        }, 1000);
      }
    });
    
    // Auto-save issue on blur
    issueInput.addEventListener('blur', () => {
      updateStatus('Issue note saved');
      // Clear timeout and save immediately on blur
      clearTimeout(issueInputTimeout);
      autoSave();
    });
    
    // Auto-save function
    async function autoSave() {
      if (excelData && excelData.length > 1) {
        try {
          await ipcRenderer.invoke('save-excel', excelData);
          console.log('Auto-saved data successfully');
          // 显示简短的自动保存提示
          const originalText = statusEl.textContent;
          const originalBg = statusEl.style.backgroundColor;
          const originalColor = statusEl.style.color;
          
          statusEl.textContent = '💾 Auto-saved';
          statusEl.style.backgroundColor = '#e8f5e8';
          statusEl.style.color = '#2e7d32';
          
          // 2秒后恢复原状态
          setTimeout(() => {
            statusEl.textContent = originalText;
            statusEl.style.backgroundColor = originalBg;
            statusEl.style.color = originalColor;
          }, 2000);
        } catch (error) {
          console.error('Auto-save failed:', error);
          // 不显示错误给用户，因为这是自动保存
        }
      }
    }
    
    // Initialize
    // loadExcelData(); // 注释掉自动加载，现在由文件选择触发
    
    // 初始化应用
    function initApp() {
      // 初始化开关状态
      autoNextToggle.classList.add('active');
      
      // 初始化标签功能
      initTagSystem();
      
      // 初始化自定义快捷键功能
      initCustomShortcuts();
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', initApp);
    
    // 添加标签按钮事件
    addTagBtn.addEventListener('click', () => {
      addTagInput.classList.remove('hidden');
      newTagInput.focus();
    });
    
    // 保存新标签
    saveTagBtn.addEventListener('click', () => {
      const tagText = newTagInput.value.trim();
      if (tagText) {
        addCustomTag(tagText);
        newTagInput.value = '';
        addTagInput.classList.add('hidden');
      }
    });
    
    // 取消添加标签
    cancelTagBtn.addEventListener('click', () => {
      newTagInput.value = '';
      addTagInput.classList.add('hidden');
    });
    
    // 新标签输入框回车事件
    newTagInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        saveTagBtn.click();
      } else if (e.key === 'Escape') {
        cancelTagBtn.click();
      }
    });
    
    // 编辑标签事件监听器
    saveEditBtn.addEventListener('click', saveEditedTag);
    cancelEditBtn.addEventListener('click', cancelEditingTag);
    
    // 编辑标签输入框回车事件
    editTagText.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        saveEditedTag();
      } else if (e.key === 'Escape') {
        cancelEditingTag();
      }
    });
    
    // 标签相关函数
    function appendIssueTag(tagText) {
      const currentValue = issueInput.value.trim();
      if (currentValue) {
        issueInput.value = currentValue + ', ' + tagText;
      } else {
        issueInput.value = tagText;
      }
      
      // 更新Excel数据
      if (excelData[currentIndex]) {
        excelData[currentIndex][columns.issue] = issueInput.value;
        updateStatus(`Added tag: ${tagText}`);
        
        // 检查自动fail功能
        if (autoFailEnabled && issueInput.value.trim() && excelData[currentIndex][columns.result] !== 0) {
          // 有issue内容且当前不是fail状态，自动设为fail
          excelData[currentIndex][columns.result] = 0;
          currentScoreEl.textContent = '❌ Failed (0)';
          currentScoreEl.style.color = '#d32f2f';
          updateContainerStatus(0);
          updateStatus('Auto-failed due to issue tag');
          
          // 更新Progress Overview
          updateProgressOverview();
        }
        
        autoSave();
      }
    }
    
    function clearIssueInput() {
      issueInput.value = '';
      if (excelData[currentIndex]) {
        excelData[currentIndex][columns.issue] = '';
        updateStatus('Issue notes cleared');
        autoSave();
      }
    }
    
    // 自动跳转开关事件
    autoNextToggle.addEventListener('click', () => {
      autoNextEnabled = !autoNextEnabled;
      autoNextToggle.classList.toggle('active', autoNextEnabled);
      updateStatus(autoNextEnabled ? 'Auto-advance enabled' : 'Auto-advance disabled');
    });
    
    // 自动Fail开关事件
    autoFailToggle.addEventListener('click', () => {
      autoFailEnabled = !autoFailEnabled;
      autoFailToggle.classList.toggle('active', autoFailEnabled);
      updateStatus(autoFailEnabled ? 'Auto-fail on issue enabled' : 'Auto-fail on issue disabled');
    });
    
    // 预加载页数设置事件
    preloadCountSelect.addEventListener('change', (e) => {
      maxPreloadPages = parseInt(e.target.value);
      updateStatus(`Preload count set to ${maxPreloadPages} pages`);
      
      // 重新开始预加载
      if (excelData && excelData.length > 1) {
        startPreloading();
      }
    });
    
    // 页码跳转事件
    jumpBtn.addEventListener('click', () => {
      const targetPage = parseInt(pageJumpInput.value);
      const maxPage = excelData ? excelData.length - 1 : 1;
      
      if (targetPage >= 1 && targetPage <= maxPage) {
        loadPage(targetPage);
        updateStatus(`Jumped to page ${targetPage}`);
      } else {
        showError(`Invalid page number. Please enter a number between 1 and ${maxPage}`);
        pageJumpInput.value = currentIndex;
      }
    });
    
    // 页码输入框回车事件
    pageJumpInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        jumpBtn.click();
      }
    });
    
    // 自定义快捷键事件监听器
    resetShortcutsBtn.addEventListener('click', resetAllShortcuts);
    
    toggleShortcutsBtn.addEventListener('click', () => {
      shortcutsVisible = !shortcutsVisible;
      const shortcutsPanel = document.getElementById('shortcuts-config-panel');
      if (shortcutsVisible) {
        shortcutsPanel.style.display = 'block';
        toggleShortcutsBtn.textContent = '⌨️ Hide Custom Shortcuts';
        toggleShortcutsBtn.style.backgroundColor = '#dc3545';
      } else {
        shortcutsPanel.style.display = 'none';
        toggleShortcutsBtn.textContent = '⌨️ Custom Shortcuts';
        toggleShortcutsBtn.style.backgroundColor = '#6c757d';
      }
    });
    
    // 初始化时隐藏快捷键配置列表
    window.addEventListener('load', () => {
      const shortcutsPanel = document.getElementById('shortcuts-config-panel');
      if (shortcutsPanel) {
        shortcutsPanel.style.display = 'none'; // 默认隐藏
        shortcutsVisible = false; // 设置状态为隐藏
        toggleShortcutsBtn.textContent = '⌨️ Custom Shortcuts'; // 按钮文字
        toggleShortcutsBtn.style.backgroundColor = '#6c757d'; // 灰色背景
      }
    });
    
    // File selection
    fileBtn.addEventListener('click', async () => {
      try {
        const result = await ipcRenderer.invoke('select-file');
        if (result.success) {
          await loadExcelData();
        }
      } catch (error) {
        showError(`File selection failed: ${error.message}`);
      }
    });
    
    // Download sample Excel file
    downloadSampleBtn.addEventListener('click', async () => {
      try {
        updateStatus('Preparing sample Excel template...');
        const result = await ipcRenderer.invoke('download-sample-excel');
        if (result.success) {
          updateStatus(`✅ Sample template saved: ${result.fileName}`);
          
          // 显示成功消息和指引
          const message = `
            📥 样例Excel模板已下载！
            
            🔧 使用指引：
            1. 编辑Excel文件，填入您的网页数据
            2. 必填列：description/query（描述）、link（网页链接）
            3. 可选列：thumbnail_link（缩略图）
            4. 系统列：result（评分结果）、issue（问题备注）、screenshot（截图路径）
            
            📂 保存位置：${result.filePath}
          `;
          
          alert(message);
        } else {
          showError(result.error || 'Failed to download sample template');
        }
      } catch (error) {
        showError(`Download failed: ${error.message}`);
      }
    });
    
    // 缩略图点击放大
    thumbnailPreview.addEventListener('click', () => {
      if (thumbnailPreview.src && !thumbnailPreview.classList.contains('hidden')) {
        showFullscreenImage(thumbnailPreview.src);
      }
    });

    // Load Excel data
    async function loadExcelData() {
      try {
        updateStatus('Loading Excel file...');
        const result = await ipcRenderer.invoke('load-excel');
        
        if (result.success) {
          excelData = result.data;
          columns = result.columns;
          currentIndex = 1; // 从1开始，跳过标题行
          
          // 更新页码跳转输入框的最大值
          const maxPage = excelData.length - 1;
          pageJumpInput.max = maxPage;
          pageJumpInput.value = 1;
          
          // Enable controls
          prevBtn.disabled = false;
          nextBtn.disabled = false;
          passBtn.disabled = false;
          failBtn.disabled = false;
          screenshotBtn.disabled = false;
          saveBtn.disabled = false;
          reloadBtn.disabled = false;
          openExternalBtn.disabled = false;
          
          updateStatus(`✅ Loaded ${maxPage} pages from Excel file`);
          loadPage(1); // 加载第一页数据
          
          // 初始化Progress Overview
          initializeProgressOverview();
          
          // 开始预加载
          startPreloading();
        } else {
          showError(result.error || 'Failed to load Excel file');
        }
      } catch (error) {
        showError(`Failed to load Excel: ${error.message}`);
      }
    }
    
    // 修改键盘快捷键，使用自定义快捷键系统
    document.addEventListener('keydown', (e) => {
      // 如果正在录制快捷键，记录按键
      if (recordingShortcut) {
        e.preventDefault();
        
        // ESC取消录制
        if (e.key === 'Escape') {
          cancelRecordingShortcut();
          return;
        }
        
        // 收集按键组合
        const keys = [];
        if (e.ctrlKey) keys.push('Control');
        if (e.altKey) keys.push('Alt');
        if (e.shiftKey) keys.push('Shift');
        if (e.metaKey) keys.push('Meta');
        
        // 添加主键（过滤修饰键）
        if (!['Control', 'Alt', 'Shift', 'Meta'].includes(e.key)) {
          keys.push(e.key);
        }
        
        if (keys.length > 0) {
          saveRecordedShortcut(keys);
        }
        return;
      }
      
      // 如果用户在输入框中，只响应部分快捷键
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        // 保存快捷键
        if (isShortcutMatch(e, customShortcuts.save.keys)) {
          e.preventDefault();
          saveBtn.click();
          return;
        }
        
        // Issue标签快捷键在输入框中也要响应
        if ((e.ctrlKey || e.metaKey) && !isNaN(e.key)) {
          e.preventDefault();
          const num = parseInt(e.key);
          if (num === 0) {
            clearIssueInput();
          } else if (num >= 1 && num <= 9) {
            const targetTag = document.querySelector(`[data-shortcut="${num}"]`);
            if (targetTag) {
              appendIssueTag(targetTag.dataset.tag);
            }
          }
        }
        return;
      }
      
      // 检查所有自定义快捷键
      for (const [action, config] of Object.entries(customShortcuts)) {
        if (isShortcutMatch(e, config.keys)) {
          e.preventDefault();
          executeShortcutAction(action);
          return;
        }
      }
      
      // Issue标签快捷键 (扩展到1-9)
      if ((e.ctrlKey || e.metaKey) && !isNaN(e.key)) {
        e.preventDefault();
        const num = parseInt(e.key);
        if (num === 0) {
          clearIssueInput();
        } else if (num >= 1 && num <= 9) {
          const targetTag = document.querySelector(`[data-shortcut="${num}"]`);
          if (targetTag) {
            appendIssueTag(targetTag.dataset.tag);
            // 视觉反馈
            targetTag.classList.add('active');
            setTimeout(() => targetTag.classList.remove('active'), 200);
          }
        }
      }
    });
    
    // 检查快捷键是否匹配
    function isShortcutMatch(event, shortcutKeys) {
      if (!shortcutKeys || shortcutKeys.length === 0) return false;
      
      const pressedKeys = [];
      if (event.ctrlKey) pressedKeys.push('Control');
      if (event.altKey) pressedKeys.push('Alt');
      if (event.shiftKey) pressedKeys.push('Shift');
      if (event.metaKey) pressedKeys.push('Meta');
      
      // 添加主键（过滤修饰键）
      if (!['Control', 'Alt', 'Shift', 'Meta'].includes(event.key)) {
        pressedKeys.push(event.key);
      }
      
      // 比较按键组合
      return pressedKeys.sort().join('+') === shortcutKeys.sort().join('+');
    }
    
    // 执行快捷键动作
    function executeShortcutAction(action) {
      switch (action) {
        case 'previous':
          if (!prevBtn.disabled) loadPage(currentIndex - 1);
          break;
        case 'next':
          if (!nextBtn.disabled) loadPage(currentIndex + 1);
          break;
        case 'pass':
          if (!passBtn.disabled) passBtn.click();
          break;
        case 'fail':
          if (!failBtn.disabled) failBtn.click();
          break;
        case 'save':
          saveBtn.click();
          break;
        case 'screenshot':
          if (!screenshotBtn.disabled) screenshotBtn.click();
          break;
        case 'reload':
          if (!reloadBtn.disabled) reloadBtn.click();
          break;
        case 'openExternal':
          if (!openExternalBtn.disabled) openExternalBtn.click();
          break;
        case 'clearTags':
          clearIssueInput();
          break;
        case 'toggleAutoNext':
          autoNextToggle.click();
          break;
        case 'focusJump':
          pageJumpInput.focus();
          pageJumpInput.select();
          break;
        default:
          console.log('Unknown shortcut action:', action);
      }
    }
    
    // 添加窗口调整事件监听
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        adjustBrowserViewPosition();
      }, 250);
    });
    
    // 添加滚动事件监听，滚动时隐藏BrowserView
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      ipcRenderer.invoke('hide-browser-view');
      
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        adjustBrowserViewPosition();
      }, 150);
    });
    
    // BrowserView位置调整函数
    function adjustBrowserViewPosition() {
      const rect = webFrame.getBoundingClientRect();
      ipcRenderer.invoke('adjust-browser-view', {
        x: Math.round(rect.left),
        y: Math.round(rect.top),
        width: Math.round(rect.width),
        height: Math.round(rect.height)
      });
    }
    
    // Utility functions
    function updateStatus(message) {
      statusEl.textContent = message;
      statusEl.style.backgroundColor = '#f2f2f2';
      statusEl.style.color = '#333';
    }
    
    function showError(message) {
      statusEl.textContent = message;
      statusEl.style.backgroundColor = '#ffebee';
      statusEl.style.color = '#c62828';
    }
    
    // 更新容器背景状态
    function updateContainerStatus(score) {
      const container = document.querySelector('.container');
      container.classList.remove('status-unscored', 'status-pass', 'status-fail');
      
      if (score === 1) {
        container.classList.add('status-pass');
      } else if (score === 0) {
        container.classList.add('status-fail');
      } else {
        container.classList.add('status-unscored');
      }
    }
    
    // 全屏显示图片
    function showFullscreenImage(src) {
      // 隐藏BrowserView以确保图片显示在最上层
      ipcRenderer.invoke('hide-browser-view');
      
      // 创建全屏覆盖层
      const overlay = document.createElement('div');
      overlay.className = 'fullscreen-overlay';
      
      // 创建全屏图片
      const img = document.createElement('img');
      img.className = 'fullscreen-image';
      img.src = src;
      
      overlay.appendChild(img);
      document.body.appendChild(overlay);
      
      // 关闭函数
      const closeOverlay = () => {
        document.body.removeChild(overlay);
        // 恢复BrowserView显示
        adjustBrowserViewPosition();
      };
      
      // 点击关闭
      overlay.addEventListener('click', closeOverlay);
      
      // ESC键关闭
      const closeOnEsc = (e) => {
        if (e.key === 'Escape') {
          closeOverlay();
          document.removeEventListener('keydown', closeOnEsc);
        }
      };
      document.addEventListener('keydown', closeOnEsc);
    }
    
    // Progress Overview Functions
    function initializeProgressOverview() {
      if (!excelData || excelData.length <= 1) {
        // 清空显示
        progressGrid.innerHTML = '';
        updateProgressStats(0, 0, 0, 0);
        return;
      }
      
      const totalPages = excelData.length - 1; // 排除标题行
      updateProgressStats(0, 0, totalPages, totalPages);
      createProgressGrid();
      updateProgressOverview();
    }
    
    function createProgressGrid() {
      if (!excelData || excelData.length <= 1) return;
      
      const totalPages = excelData.length - 1; // 排除标题行
      progressGrid.innerHTML = '';
      
      for (let i = 1; i <= totalPages; i++) { // 从1开始，跳过标题行
        const item = document.createElement('div');
        item.className = 'progress-item';
        item.dataset.pageIndex = i;
        item.title = `Page ${i}: ${(excelData[i][columns.description] || excelData[i][columns.query] || 'No description').substring(0, 50)}...`;
        
        // 点击跳转到对应页面
        item.addEventListener('click', () => {
          loadPage(i);
        });
        
        progressGrid.appendChild(item);
      }
    }
    
    function updateProgressOverview() {
      if (!excelData || excelData.length <= 1) return;
      
      let passCount = 0;
      let failCount = 0;
      let pendingCount = 0;
      const totalPages = excelData.length - 1; // 排除标题行
      
      // 统计各状态的页面数量
      for (let i = 1; i <= totalPages; i++) { // 从1开始，跳过标题行
        const result = excelData[i][columns.result];
        if (result === 1) {
          passCount++;
        } else if (result === 0) {
          failCount++;
        } else {
          pendingCount++;
        }
      }
      
      // 更新统计数据
      updateProgressStats(passCount, failCount, pendingCount, totalPages);
      
      // 更新网格显示
      const items = progressGrid.querySelectorAll('.progress-item');
      items.forEach((item, index) => {
        const pageIndex = index + 1; // 对应实际的页面索引
        const result = excelData[pageIndex][columns.result];
        
        // 移除所有状态类
        item.classList.remove('pass', 'fail', 'pending', 'current');
        
        // 添加对应的状态类
        if (pageIndex === currentIndex) {
          item.classList.add('current');
        } else if (result === 1) {
          item.classList.add('pass');
        } else if (result === 0) {
          item.classList.add('fail');
        } else {
          item.classList.add('pending');
        }
      });
    }
    
    function updateProgressStats(passCount, failCount, pendingCount, totalCount) {
      passCountEl.textContent = passCount;
      failCountEl.textContent = failCount;
      pendingCountEl.textContent = pendingCount;
      totalCountEl.textContent = totalCount;
    }
  </script>
</body>
</html> 